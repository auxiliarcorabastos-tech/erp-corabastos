<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ERP Corabastos</title>

  <link rel="stylesheet" href="styles.css" />

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://drvurgbsuiwnmwgikykg.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRydnVyZ2JzdWl3bm13Z2lreWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjc2NzIsImV4cCI6MjA3OTg0MzY3Mn0.pMAsD8ogQWLy-GPXs5fAmFCeokThb3pU4q46pdzDeyw";

    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>

<body>

  <!-- HEADER -->
  <header style="display:flex;justify-content:space-between;padding:10px;background:#eee">
    <h2>ERP Corabastos</h2>

    <div>
      <span id="headerUser" style="margin-right:10px;font-weight:bold;"></span>
      <button id="btnLogout" style="display:none;">Salir</button>
    </div>
  </header>

  <!-- Aquí irá TU ERP (restaurado en el siguiente paso) -->
  <div id="appContent">
    <p style="padding:20px;color:#666">Cargando ERP…</p>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal"
       style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;
       align-items:center;justify-content:center;z-index:1000;">
    <div style="background:#fff;padding:20px;border-radius:12px;width:300px;text-align:center">
      <h3>Iniciar sesión</h3>

      <input id="login_user" placeholder="Usuario"
             style="width:100%;margin:6px 0;padding:6px">

      <input id="login_pass" type="password" placeholder="Contraseña"
             style="width:100%;margin:6px 0;padding:6px">

      <button id="btnLogin" style="margin-top:10px;width:100%">Entrar</button>
    </div>
  </div>

  <!-- AUTH LOGIC -->
  <script type="module">

    const loginModal = document.getElementById("loginModal");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const headerUser = document.getElementById("headerUser");
    const appContent = document.getElementById("appContent");

    async function checkSession() {
      const { data } = await supabase.auth.getSession();

      if (data.session) {
        const email = data.session.user.email;

        // Convertimos email → username
        headerUser.textContent = email.split("@")[0];

        btnLogout.style.display = "inline-block";
        loginModal.style.display = "none";

        // Carga el ERP real
        appContent.innerHTML = `<h3 style="padding:20px;">Bienvenido ${headerUser.textContent}</h3>`;
      } else {
        loginModal.style.display = "flex";
        appContent.innerHTML = "";
      }
    }

    btnLogin.onclick = async () => {
      const username = document.getElementById("login_user").value.trim();
      const pass = document.getElementById("login_pass").value;

      const email = `${username}@fake.local`;

      const { error } = await supabase.auth.signInWithPassword({
        email,
        password: pass
      });

      if (error) {
        alert("Usuario o contraseña incorrectos");
        return;
      }

      checkSession();
    };

    btnLogout.onclick = async () => {
      await supabase.auth.signOut();
      checkSession();
    };

    checkSession();
  </script>

</body>
</html>
