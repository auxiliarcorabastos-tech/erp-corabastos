(function(){const $=id=>document.getElementById(id);let state=JSON.parse(localStorage.getItem('erp_state')||'null')||{};state.foundations=Array.isArray(state.foundations)?state.foundations:[];state.items=Array.isArray(state.items)?state.items:[];state.drivers=Array.isArray(state.drivers)?state.drivers:[];state.plates=Array.isArray(state.plates)?state.plates:[];state.pedidos=Array.isArray(state.pedidos)?state.pedidos:[];function save(){localStorage.setItem('erp_state',JSON.stringify(state))}function showSection(id){document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));const el=$(id);if(el)el.classList.remove('hidden');document.querySelectorAll('#sidebar button').forEach(b=>b.classList.remove('active'));const btn=document.querySelector('#sidebar button[data-sec="'+id+'"]');if(btn)btn.classList.add('active')}document.querySelectorAll('#sidebar button').forEach(b=>b.addEventListener('click',()=>showSection(b.dataset.sec)));function renderFund(){const box=$('fundList');if(!box)return;box.innerHTML='';state.foundations.forEach(f=>{const d=document.createElement('div');d.className='card';d.style.marginBottom='8px';d.innerHTML='<strong>'+f.name+'</strong><div class="small">NIT: '+f.nit+'</div>';box.appendChild(d)})}function renderItems(){const tbody=$('itemsTable').querySelector('tbody');tbody.innerHTML='';state.items.forEach(it=>{const tr=document.createElement('tr');tr.innerHTML='<td>'+it.ref+'</td><td>'+it.name+'</td><td>$'+(it.price||0)+'</td>';tbody.appendChild(tr)})}function renderDrivers(){const ul=$('driversList');if(!ul)return;ul.innerHTML='';state.drivers.forEach(d=>{const li=document.createElement('li');li.textContent=d.name+' — '+(d.document||'');ul.appendChild(li)})}function renderPedidos(){const ul=$('pedidosList');if(!ul)return;ul.innerHTML='';state.pedidos.forEach(p=>{const li=document.createElement('li');li.style.marginBottom='8px';li.innerHTML='<strong>'+p.id+'</strong> — '+p.foundation+' — $'+(p.total||0)+'<div class="small">'+new Date(p.createdAt).toLocaleString()+'</div>';ul.appendChild(li)})}function fillSelects(){const s=$('pd_item_sel');if(s){s.innerHTML='';state.items.forEach((it,i)=>s.appendChild(new Option(it.name+' - $'+it.price,i)))} const sd=$('pd_driver');if(sd){sd.innerHTML='';state.drivers.forEach((d,i)=>sd.appendChild(new Option(d.name,i)))} const sp=$('pd_plate');if(sp){sp.innerHTML='';state.plates.forEach((p,i)=>sp.appendChild(new Option(p.plate,i)))}}
$('btnFundCreate').addEventListener('click',()=>{const nit=$('f_nit').value.trim();const name=$('f_name').value.trim();if(!nit||!name)return alert('Complete NIT y nombre');state.foundations.push({nit,name,points:[]});save();renderFund();$('f_nit').value='';$('f_name').value='';});$('btnCreateItem').addEventListener('click',()=>{const ref=$('item_ref').value.trim();const name=$('item_name').value.trim();const price=Number($('item_price').value)||0;if(!ref||!name)return alert('Referencia y nombre');state.items.push({ref,name,price});save();renderItems();fillSelects();$('item_ref').value='';$('item_name').value='';$('item_price').value='';});$('btnAddDriver').addEventListener('click',()=>{const name=$('drv_name').value.trim();const doc=$('drv_doc').value.trim();if(!name)return alert('Nombre requerido');state.drivers.push({name,document:doc});save();renderDrivers();fillSelects();$('drv_name').value='';$('drv_doc').value='';});
let _curPedidoItems=[];$('pd_add_item').addEventListener('click',()=>{const idx=Number($('pd_item_sel').value);if(isNaN(idx)||!state.items[idx])return alert('Seleccione item');const kgs=Number($('pd_kilos').value);if(!kgs)return alert('Kilos obligatorios');const it=state.items[idx];const qty=Number($('pd_pack_qty').value)||1;_curPedidoItems.push({name:it.name,price:it.price,qty,kgs});refreshPdItems();});function refreshPdItems(){const ul=$('pd_items_list');ul.innerHTML='';_curPedidoItems.forEach((it,idx)=>{const li=document.createElement('li');li.textContent=it.name+' x'+it.qty+' — '+it.kgs+'kg — $'+it.price;const del=document.createElement('button');del.textContent='Eliminar';del.style.marginLeft='8px';del.addEventListener('click',()=>{_curPedidoItems.splice(idx,1);refreshPdItems()});li.appendChild(del);ul.appendChild(li)})}
$('btnAddPedido').addEventListener('click',()=>{const nit=$('pd_nit').value.trim();const f=(state.foundations.find(x=>x.nit===nit)||{});if(!f.name){alert('Fundación no encontrada');return;} if(!_curPedidoItems.length) return alert('Agregue items');const peaje=Number($('pd_peaje').value)||0;const trans=Number($('pd_trans').value)||0;const subtotal=_curPedidoItems.reduce((s,it)=>s+(it.price||0)*(it.qty||1),0);const total=subtotal+peaje+trans;const pedido={id:'PED-'+Date.now(),foundation:f.name,foundationNIT:f.nit,point:$('pd_point').value,items:_curPedidoItems.slice(),peaje,trans,total,createdAt:new Date().toISOString()};state.pedidos.unshift(pedido);save();_curPedidoItems=[];refreshPdItems();renderPedidos();alert('Pedido creado: '+pedido.id);});$('btnExportPedidoCSV').addEventListener('click',()=>{const rows=[['id','fundacion','item','qty','kgs','price','peaje','trans','total','fecha']];state.pedidos.forEach(p=>p.items.forEach(it=>rows.push([p.id,p.foundation,it.name,it.qty,it.kgs,it.price,p.peaje,p.trans,p.total,p.createdAt])));const csv=rows.map(r=>r.map(c=>'"'+(''+c).replace(/"/g,'""')+'"').join(',')).join('\n');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='pedidos.csv';a.click();URL.revokeObjectURL(url);});$('btnExportPedidoIMG')&&$('btnExportPedidoIMG').addEventListener('click',()=>{const p=state.pedidos[0];if(!p)return alert('No hay pedidos');const w=window.open('','_blank');w.document.write('<pre>'+JSON.stringify(p,null,2)+'</pre>');});function init(){renderFund();renderItems();renderDrivers();renderPedidos();fillSelects();showSection('dashboard')}init();})();